---
    comments: true
 
---

# 网络层

## 概述

网络层的主要任务是将分组通过多个网络和多段链路传输到目的主机，即**分组转发**+**路由选择**

### 网络层上层提供的服务

- 面向连接的虚电路服务
    - 先建立网络层链接：虚电路（VC），通信双方沿着 VC 发送分组
- 无连接的数据报服务
    - 不需要建立网络层连接，每个分组可走不同的路径

## IP 协议

### 异构网络互连

单一网络无法满足所有用户的需求，于是网络层采用相同的 IP 协议，貌似一个统一的网络。

### IPv4

IPv4地址是给因特网（Internet）上的每一个主机（或路由器）的每一个接口分配的一个在全世界范围内唯一的32比特的标识符。

采用点分十进制表示法：

![IPv4](../assets/CN31.png)

#### 分类编址

IPv4地址分为两部分：网络号（NetID）和主机号（HostID）

- 网络号
    - 标志主机（或路由器）的接口所连接到的网络
    - 同一个网络中，不同主机（或路由器）的接口的IPv4地址的网络号必须相同，表示它们属于同一个网络。
- 主机号
    - 标志主机（或路由器）的接口
    - 同一个网络中，不同主机（或路由器）的接口的IPv4地址的主机号必须不同，表示它们是同一网络中的不同主机（或路由器）。

例：C 类地址192.168.0.1，其中192.168.0是网络号，1是主机号；B 类地址 172.16.96.1，其中 172.16 是网络号，96.1是主机号。

怎么判断一个IPv4地址的网络号和主机号的边界在哪里呢？这就要用到分类编址。

!!! note "分类编址"
    IPv4地址分为A、B、C、D、E五类。

    ![分类编址](../assets/CN32.png)

    只有 ABC 类（单播地址）用于分配给主机（或路由器）的接口，且主机号为全 0 （网络地址）或全 1 （广播地址）的地址不能分配.

    - A 类
        - 最小网络号 0 和最大网络号 127 的地址不能指派，**可指派网络数量**为 $2^{8-1}-2 = 126$
        - 最小可指派网络号为 1（IP 地址为 1.0.0.0），最大可指派网络号为 126（IP 地址为 126.0.0.0）
        - 主机全 0 全 1 不能分配，每个网络内**可分配地址数量**为 $2^{24}-2=16777214$
    - B 类
        - **可指派网络数量**为 $2^{16-2}=16384$
        - 最小可指派网络号为 128.0（IP 地址为 128.0.0.0），最大可指派网络号为 191.255（IP 地址为 191.255.0.0）
        - 每个网络内**可分配地址数量**为 $2^{16}-2=65534$
    - C 类
        - **可指派网络数量**为 $2^{24-3}=2097152$
        - 最小可指派网络号为 192.0.0（IP 地址为 192.0.0.0），最大可指派网络号为 223.255.255 (IP 地址为 223.255.255.0)
        - 每个网络内**可分配地址数量**为 $2^{8}-2=254$
    - DE 类
        - ![DE 类地址](../assets/CN33.png)

!!! note "一般不使用的地址"
    | 网络号 | 主机号 | IP 地址 | 作为源地址 | 作为目的地址 | 说明 |
    | ------ | ------ | ------- | ---------- | ------------- | ---- |
    | 0 | 0 | 0.0.0.0 | 可以 | 不可以 | 在本网络上的本主机 |
    | 0 | hostID | 0.hostID | 可以 | 不可以 | 在本网络上的主机 hostID |
    | 全 1 | 全 1 | 255.255.255.255 | 不可以 | 可以 | 只在本网络上进行广播 |
    | netID | 全 1 | netID.255.255.255（A 类），netID.255.255（B 类），netID.255（C 类） | 不可以 | 可以 | 在网络 netID 上所有主机进行广播 |
    | 127 | 非全 0 或全 1 | 127.0.0.1~127.255.255.254 | 可以 | 可以 | 回环测试 |

#### 子网划分

从IPv4地址的主机号部分借用一些比特作为子网号来区分不同的子网，就可以利用原有网络中剩余的大量IPv4地址，而不用申请新的网络地址了。

使用子网掩码表明主机号部分被借用了几个比特作为**子网号**：用左起多个连续的比特1对应IPv4地址中的网络号和子网号，之后的多个连续的比特0对应IPv4地址中的主机号。

将划分子网的IPv4地址与相应的子网掩码进行逐比特的逻辑与运算，就可得到该IPv4地址所在子网的网络地址（网络号+子网号与 1 与，被保留，主机号与 0 与，被清零）。

默认子网掩码：

- A 类：`255.0.0.0`
- B 类：`255.255.0.0`
- C 类：`255.255.255.0`

#### 无分类编址

类似子网掩码，地址掩码

- 左起多个连续的比特1对应IPv4地址中的网络前缀
- 之后的多个连续的比特0对应IPv4地址中的主机号

斜线记法：`ipv4 addr / #bits of network prefix`